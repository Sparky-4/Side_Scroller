<!DOCTYPE html>
<html>
<head>
	<title></title>
	<link href='https://fonts.googleapis.com/css?family=Electrolize' rel='stylesheet'>
	<style>
		body {
			overflow: hidden;
			margin: 0px;
		}
		
	</style>

</head>
<body onLoad = requestAnimationFrame(start)>

<canvas id="myCanvas"></canvas>

<!--js scripts for objects and misc.-->
<script src="src/Quad.js"></script>
<script src="src/Util.js"></script>
<script src="src/constants.js"></script>
<script src="src/Animation.js"></script>
<script src="src/Timer.js"></script>
<script src="src/character.js"></script>

<script>

    // Declare and initialize the canvas variables
    let cameraScroll = 0;
    let canvas = document.getElementById("myCanvas");
    let ctx = canvas.getContext("2d");
    ctx.save();
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Variables for finding FPS
    const times = [];
    let fps;

    // Load new font from the font files
    let font = new FontFace('font', 'url(fonts/font.ttf)');
    font.load().then(function(loaded_face) {
        document.fonts.add(loaded_face);
    })
    
    // Declare and initialize objects that holds fonts
    let gFonts = {
        small: 8*SCALE_FACTOR_WIDTH + "px font",
        medium: 16*SCALE_FACTOR_WIDTH + "px font",
        large: 32*SCALE_FACTOR_WIDTH + "px font",
        other: 4*SCALE_FACTOR_WIDTH + "px Arial"
    };

    // Declare all images as image objects in a global textures object
    let gTextures = {
        main: new Image(480, 640),
        toppers: new Image(480, 1152),
        character: new Image(352, 20),
        backgrounds: new Image(256, 384),
    };
    
    // Initialize all images from files
    gTextures.main.src = "graphics/tiles.png";
    gTextures.toppers.src = "graphics/tile_tops.png";
    gTextures.character.src = "graphics/character.png";
    gTextures.backgrounds.src = "graphics/backgrounds.png";

    // Declare and initialize quads for all textures as objects using the util.js functions
    gFrames = {
        tiles: GenerateTiles(gTextures.main),
        toppers: GenerateToppers(gTextures.toppers),
        character: GenerateQuads(gTextures.character, 16, 20, 16, 20),
        backgrounds: GenerateQuads(gTextures.backgrounds, 256, 128, 256, 128)
    }
    let tileSet = randInt(0, gFrames.tiles.length-1);
    let topperSet = randInt(0, gFrames.toppers.length-1);
    let background = randInt(0, 2);

    // Add event listeners for keydown and keyup and change the array "keys" accordingly
    let keys = [];
    window.addEventListener('keydown', function (e) {
        keys[e.keyCode] = true;
        if(e.keyCode == 82){
            tileSet = randInt(0, gFrames.tiles.length-1);
            topperSet = randInt(0, gFrames.toppers.length-1);
            background = randInt(0, 2);
        }
        if(e.keyCode == 81){
            generateLevel();
        }
    })
    window.addEventListener('keyup', function (e) {
        keys[e.keyCode] = false;
    })

    //Level Generation
    let C;
    let level = [];
    function generateLevel(){
        for(let i = 0; i < 100; i++){
            let col = [];
            for(let j = 0; j < 9; j++){
                col[j] = {
                    id: 0,
                    topper: false
                };
            }
            level[i] = col;
        }
        for(let i = 0; i < 100; i++){
            if(randInt(1, 7) == 1)
                continue;
            let pillerFlag = false;
            if(randInt(1, 5) == 1)
                pillerFlag = true;
            for(let j = 0; j < 9; j++){
                if(j >= 7 || (pillerFlag && j >= 5))
                    level[i][j].id = 1;
                if((pillerFlag && j == 5) || (!pillerFlag && j == 7))
                    level[i][j].topper = true;
            }
        }
    }

    function drawLevel(){
        for(let i = 0; i < 100; i++){
            for(let j = 0; j < 9; j++){
                if(level[i][j].id == 1)
                    gFrames.tiles[tileSet][12].draw(i*16*SCALE_FACTOR_WIDTH, j*SCALE_FACTOR_HEIGHT*16);
                if(level[i][j].topper)
                    gFrames.toppers[topperSet][2].draw(i*16*SCALE_FACTOR_WIDTH, j*SCALE_FACTOR_HEIGHT*16);

            }
        }
    }

    function start(){
        generateLevel();
        C = new Character();
        update();
    }

    /* 
    * The update function - called every frame using requestAnimationFrame and updates
    * individual parts of the game
    */
    function update(){
        C.update();
        draw();
        requestAnimationFrame(update);
    }

    /*
    * Draw on the canvas and call the render functions of other necessary parts
    */
    function draw(){ 
        ctx.imageSmoothingEnabled = false; 
        ctx.fillRect(cameraScroll, 0,WINDOW_WIDTH,WINDOW_HEIGHT)
        for(let i = 0; i < 10; i++){
            gFrames.backgrounds[background].draw(Math.floor(cameraScroll*2/3) + i*256*SCALE_FACTOR_WIDTH, 0);
        }
        drawLevel();
        C.render();
        displayFPS();
    }

    /*
    * Display the FPS by adding a time stamp to the times array and removing any stamp
    * longer than one second
    */
    function displayFPS(){
        const now = performance.now();
        while (times.length > 0 && times[0] <= now - 1000) {
            times.shift();
        }
        times.push(now);
        fps = times.length;
        
        ctx.textAlign = 'left';
        ctx.font = gFonts.small;
        ctx.fillStyle = 'blue';
        ctx.fillText("FPS: " + fps, 10*SCALE_FACTOR_WIDTH + cameraScroll, 10*SCALE_FACTOR_HEIGHT);
    }

    function randInt(min, max){
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1) + min); 
    }



    
</script>


    
</body>
</html>